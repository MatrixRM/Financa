{% extends 'base.html' %}

{% block title %}Excluir Conta{% endblock %}

{% block content %}
<div class="container">
    <div class="row">
        <div class="col-lg-8 mx-auto">
            <div class="card border-danger">
                <div class="card-header bg-danger text-white">
                    <h4 class="mb-0"><i class="bi bi-exclamation-triangle"></i> Confirmar Exclusão de Conta</h4>
                </div>
                <div class="card-body">
                    {% if show_error %}
                        <div class="alert alert-danger">
                            <i class="bi bi-exclamation-circle"></i>
                            <strong>Erro ao excluir:</strong> Esta conta possui transações vinculadas.
                            Você precisa reatribuir as transações antes de excluí-la.
                        </div>
                    {% endif %}
                    
                    <p class="lead">Tem certeza que deseja excluir a conta?</p>
                    
                    <div class="alert alert-warning">
                        <strong>{{ conta.nome }}</strong> ({{ conta.get_tipo_display }})<br>
                        Saldo Atual: R$ {{ conta.saldo_atual|floatformat:2 }}
                    </div>
                    
                    {% if qtd_transacoes > 0 %}
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle"></i>
                            <strong>Atenção:</strong> Esta conta possui <strong>{{ qtd_transacoes }}</strong> transação(ões) vinculada(s).
                            <br><br>
                            Para excluir esta conta, você precisa:
                            <ul class="mb-0 mt-2">
                                <li>Reatribuir todas as transações para outra conta, ou</li>
                                <li>Excluir todas as transações manualmente primeiro</li>
                            </ul>
                        </div>
                        
                        {% if outras_contas %}
                            <form method="post" id="deleteForm">
                                {% csrf_token %}
                                
                                <div class="card mb-3">
                                    <div class="card-header bg-light">
                                        <h5 class="mb-0"><i class="bi bi-shuffle"></i> Reatribuir Transações</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="form-check mb-3">
                                            <input class="form-check-input" type="radio" name="reatribuir" id="reatribuirSim" value="sim" checked>
                                            <label class="form-check-label" for="reatribuirSim">
                                                <strong>Sim</strong>, reatribuir transações para outra conta antes de excluir
                                            </label>
                                        </div>
                                        
                                        <div id="selectContaDiv" class="ms-4 mb-3">
                                            <label for="nova_conta" class="form-label">Selecione a nova conta:</label>
                                            <select class="form-select" name="nova_conta" id="nova_conta" required>
                                                <option value="">-- Escolha uma conta --</option>
                                                {% for outra_conta in outras_contas %}
                                                    <option value="{{ outra_conta.id }}">
                                                        {{ outra_conta.nome }} ({{ outra_conta.get_tipo_display }}) - Saldo: R$ {{ outra_conta.saldo_atual|floatformat:2 }}
                                                    </option>
                                                {% endfor %}
                                            </select>
                                            <small class="form-text text-muted">
                                                As {{ qtd_transacoes }} transação(ões) serão transferidas para a conta selecionada.
                                            </small>
                                        </div>
                                        
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="reatribuir" id="reatribuirNao" value="nao">
                                            <label class="form-check-label" for="reatribuirNao">
                                                <strong>Não</strong>, cancelar a exclusão
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="d-flex gap-2">
                                    <button type="submit" class="btn btn-danger" id="btnExcluir">
                                        <i class="bi bi-trash"></i> Reatribuir e Excluir Conta
                                    </button>
                                    <a href="{% url 'conta_list' %}" class="btn btn-secondary">Cancelar</a>
                                </div>
                            </form>
                            
                            <script>
                                document.addEventListener('DOMContentLoaded', function() {
                                    const reatribuirSim = document.getElementById('reatribuirSim');
                                    const reatribuirNao = document.getElementById('reatribuirNao');
                                    const selectContaDiv = document.getElementById('selectContaDiv');
                                    const novaContaSelect = document.getElementById('nova_conta');
                                    const btnExcluir = document.getElementById('btnExcluir');
                                    const deleteForm = document.getElementById('deleteForm');
                                    
                                    function updateForm() {
                                        if (reatribuirSim.checked) {
                                            selectContaDiv.style.display = 'block';
                                            novaContaSelect.required = true;
                                            btnExcluir.innerHTML = '<i class="bi bi-trash"></i> Reatribuir e Excluir Conta';
                                            btnExcluir.disabled = false;
                                        } else {
                                            selectContaDiv.style.display = 'none';
                                            novaContaSelect.required = false;
                                            btnExcluir.innerHTML = '<i class="bi bi-x-circle"></i> Cancelar';
                                        }
                                    }
                                    
                                    reatribuirSim.addEventListener('change', updateForm);
                                    reatribuirNao.addEventListener('change', updateForm);
                                    
                                    deleteForm.addEventListener('submit', function(e) {
                                        if (reatribuirNao.checked) {
                                            e.preventDefault();
                                            window.location.href = "{% url 'conta_list' %}";
                                        } else if (reatribuirSim.checked) {
                                            if (!novaContaSelect.value) {
                                                e.preventDefault();
                                                alert('Por favor, selecione uma conta para reatribuir as transações.');
                                                return;
                                            }
                                            if (!confirm('Confirma a reatribuição de {{ qtd_transacoes }} transação(ões) e exclusão da conta "{{ conta.nome }}"?')) {
                                                e.preventDefault();
                                            }
                                        }
                                    });
                                    
                                    updateForm();
                                });
                            </script>
                        {% else %}
                            <div class="alert alert-danger">
                                <i class="bi bi-exclamation-triangle"></i>
                                <strong>Não é possível excluir esta conta!</strong><br>
                                Não há outras contas ativas para reatribuir as transações.
                                <br><br>
                                <strong>Opções:</strong>
                                <ul class="mb-0">
                                    <li>Crie outra conta primeiro</li>
                                    <li>Exclua manualmente as {{ qtd_transacoes }} transação(ões)</li>
                                    <li>Desative a conta ao invés de excluí-la</li>
                                </ul>
                            </div>
                            <div class="d-flex gap-2">
                                <a href="{% url 'conta_list' %}" class="btn btn-secondary">
                                    <i class="bi bi-arrow-left"></i> Voltar
                                </a>
                                <a href="{% url 'conta_create' %}" class="btn btn-primary">
                                    <i class="bi bi-plus-circle"></i> Criar Nova Conta
                                </a>
                            </div>
                        {% endif %}
                    {% else %}
                        <!-- Conta sem transações - pode excluir diretamente -->
                        <div class="alert alert-success">
                            <i class="bi bi-check-circle"></i>
                            Esta conta não possui transações vinculadas e pode ser excluída com segurança.
                        </div>
                        
                        <p class="text-danger">
                            <i class="bi bi-exclamation-circle"></i>
                            Esta ação não pode ser desfeita.
                        </p>
                        
                        <form method="post" class="d-flex gap-2" onsubmit="return confirm('Confirma a exclusão da conta \"{{ conta.nome }}\"?');">
                            {% csrf_token %}
                            <input type="hidden" name="reatribuir" value="nao">
                            <button type="submit" class="btn btn-danger">
                                <i class="bi bi-trash"></i> Sim, Excluir Conta
                            </button>
                            <a href="{% url 'conta_list' %}" class="btn btn-secondary">Cancelar</a>
                        </form>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
