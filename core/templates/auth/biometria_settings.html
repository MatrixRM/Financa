{% extends 'base.html' %}

{% block title %}Configurações de Biometria{% endblock %}

{% block extra_css %}
<style>
    .biometric-device {
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 1.5rem;
        margin-bottom: 1rem;
        transition: all 0.3s;
    }
    
    .biometric-device:hover {
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .device-icon {
        font-size: 2.5rem;
        color: #0d6efd;
    }
    
    .device-info h5 {
        margin-bottom: 0.5rem;
    }
    
    .device-meta {
        font-size: 0.9rem;
        color: #6c757d;
    }
    
    .setup-section {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 2rem;
        border-radius: 12px;
        margin-bottom: 2rem;
    }
    
    .setup-btn {
        background: white;
        color: #667eea;
        border: none;
        padding: 0.75rem 2rem;
        border-radius: 25px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
    }
    
    .setup-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-lg-8 mx-auto">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="bi bi-fingerprint"></i> Autenticação Biométrica</h2>
                <a href="{% url 'dashboard' %}" class="btn btn-secondary">
                    <i class="bi bi-arrow-left"></i> Voltar
                </a>
            </div>
            
            {% if not biometria_habilitada %}
            <!-- Seção de Configuração Inicial -->
            <div class="setup-section text-center">
                <i class="bi bi-shield-check" style="font-size: 4rem;"></i>
                <h3 class="mt-3">Configure seu Login Biométrico</h3>
                <p class="mb-4">
                    Use sua digital, Face ID ou reconhecimento facial para entrar rapidamente.<br>
                    <strong>Mais seguro, mais rápido, sem senhas!</strong>
                </p>
                <button type="button" class="setup-btn" id="setupBiometricBtn">
                    <i class="bi bi-plus-circle"></i> Configurar Agora
                </button>
            </div>
            {% else %}
            <!-- Seção de Adicionar Novo Dispositivo -->
            <div class="card mb-4">
                <div class="card-body text-center">
                    <h5><i class="bi bi-plus-circle"></i> Adicionar Novo Dispositivo</h5>
                    <p class="text-muted mb-3">
                        Registre este dispositivo para login biométrico
                    </p>
                    <button type="button" class="btn btn-primary" id="addDeviceBtn">
                        <i class="bi bi-fingerprint"></i> Adicionar Dispositivo
                    </button>
                </div>
            </div>
            {% endif %}
            
            <!-- Lista de Dispositivos Registrados -->
            {% if credenciais %}
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-devices"></i> Dispositivos Registrados
                        <span class="badge bg-primary">{{ credenciais.count }}</span>
                    </h5>
                </div>
                <div class="card-body">
                    {% for credencial in credenciais %}
                    <div class="biometric-device">
                        <div class="row align-items-center">
                            <div class="col-auto">
                                <i class="bi bi-phone device-icon"></i>
                            </div>
                            <div class="col device-info">
                                <h5>{{ credencial.nome_dispositivo }}</h5>
                                <div class="device-meta">
                                    <span><i class="bi bi-calendar"></i> Registrado em: {{ credencial.criada_em|date:"d/m/Y H:i" }}</span><br>
                                    {% if credencial.ultimo_uso %}
                                    <span><i class="bi bi-clock-history"></i> Último uso: {{ credencial.ultimo_uso|date:"d/m/Y H:i" }}</span><br>
                                    {% endif %}
                                    <span><i class="bi bi-key"></i> Usado {{ credencial.sign_count }} vez{{ credencial.sign_count|pluralize:"es" }}</span>
                                </div>
                            </div>
                            <div class="col-auto">
                                <button type="button" class="btn btn-outline-danger btn-sm delete-credential-btn" 
                                        data-id="{{ credencial.id }}"
                                        data-name="{{ credencial.nome_dispositivo }}">
                                    <i class="bi bi-trash"></i> Remover
                                </button>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% else %}
            <div class="alert alert-info">
                <i class="bi bi-info-circle"></i>
                <strong>Nenhum dispositivo registrado ainda.</strong>
                Configure a biometria para começar a usar login rápido!
            </div>
            {% endif %}
            
            <!-- Informações de Segurança -->
            <div class="card mt-4">
                <div class="card-header bg-light">
                    <h6 class="mb-0"><i class="bi bi-shield-check"></i> Informações de Segurança</h6>
                </div>
                <div class="card-body">
                    <ul class="list-unstyled mb-0">
                        <li class="mb-2">
                            <i class="bi bi-check-circle text-success"></i>
                            Suas credenciais biométricas nunca saem do seu dispositivo
                        </li>
                        <li class="mb-2">
                            <i class="bi bi-check-circle text-success"></i>
                            Usamos o padrão WebAuthn (FIDO2) para máxima segurança
                        </li>
                        <li class="mb-2">
                            <i class="bi bi-check-circle text-success"></i>
                            Você pode remover dispositivos a qualquer momento
                        </li>
                        <li>
                            <i class="bi bi-check-circle text-success"></i>
                            Login tradicional com senha continua disponível
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Nome do Dispositivo -->
<div class="modal fade" id="deviceNameModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Nome do Dispositivo</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <label for="deviceNameInput" class="form-label">
                    Como você quer chamar este dispositivo?
                </label>
                <input type="text" class="form-control" id="deviceNameInput" 
                       placeholder="Ex: Meu iPhone, Notebook do Trabalho">
                <small class="text-muted">
                    Isso ajuda você a identificar qual dispositivo está registrado
                </small>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="confirmRegisterBtn">Registrar</button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const setupBtn = document.getElementById('setupBiometricBtn');
    const addDeviceBtn = document.getElementById('addDeviceBtn');
    const deviceNameModal = new bootstrap.Modal(document.getElementById('deviceNameModal'));
    const deviceNameInput = document.getElementById('deviceNameInput');
    const confirmRegisterBtn = document.getElementById('confirmRegisterBtn');
    let pendingCredential = null;
    
    // Verificar suporte WebAuthn
    if (!window.PublicKeyCredential) {
        alert('Seu navegador não suporta autenticação biométrica. Use Chrome, Edge, Safari ou Firefox atualizado.');
        if (setupBtn) setupBtn.disabled = true;
        if (addDeviceBtn) addDeviceBtn.disabled = true;
        return;
    }
    
    // Funções auxiliares
    function base64urlToArrayBuffer(base64url) {
        const base64 = base64url.replace(/-/g, '+').replace(/_/g, '/');
        const padLength = (4 - (base64.length % 4)) % 4;
        const padded = base64 + '='.repeat(padLength);
        const binary = atob(padded);
        const bytes = new Uint8Array(binary.length);
        for (let i = 0; i < binary.length; i++) {
            bytes[i] = binary.charCodeAt(i);
        }
        return bytes.buffer;
    }
    
    function arrayBufferToBase64url(buffer) {
        const bytes = new Uint8Array(buffer);
        let binary = '';
        for (let i = 0; i < bytes.length; i++) {
            binary += String.fromCharCode(bytes[i]);
        }
        const base64 = btoa(binary);
        return base64.replace(/\+/g, '-').replace(/\//g, '_').replace(/=/g, '');
    }
    
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    // Função para registrar biometria
    async function registerBiometric() {
        try {
            // 1. Obter opções do servidor
            const response = await fetch('/biometria/register/', {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            });
            
            if (!response.ok) throw new Error('Erro ao obter configuração');
            
            const options = await response.json();
            
            // 2. Preparar opções para WebAuthn
            const publicKeyOptions = {
                challenge: base64urlToArrayBuffer(options.challenge),
                rp: options.rp,
                user: {
                    id: base64urlToArrayBuffer(options.user.id),
                    name: options.user.name,
                    displayName: options.user.displayName
                },
                pubKeyCredParams: options.pubKeyCredParams,
                timeout: options.timeout,
                authenticatorSelection: options.authenticatorSelection
            };
            
            // 3. Criar credencial
            const credential = await navigator.credentials.create({
                publicKey: publicKeyOptions
            });
            
            // Guardar credencial para enviar depois
            pendingCredential = {
                id: credential.id,
                rawId: arrayBufferToBase64url(credential.rawId),
                type: credential.type,
                response: {
                    clientDataJSON: arrayBufferToBase64url(credential.response.clientDataJSON),
                    attestationObject: arrayBufferToBase64url(credential.response.attestationObject),
                    publicKey: credential.response.getPublicKey ? arrayBufferToBase64url(credential.response.getPublicKey()) : ''
                }
            };
            
            // Mostrar modal para nome do dispositivo
            deviceNameModal.show();
            
        } catch (error) {
            console.error('Erro:', error);
            alert('Erro ao registrar biometria: ' + error.message);
        }
    }
    
    // Confirmar registro com nome
    confirmRegisterBtn.addEventListener('click', async function() {
        const deviceName = deviceNameInput.value.trim() || 'Meu Dispositivo';
        
        try {
            pendingCredential.deviceName = deviceName;
            
            // Enviar para servidor
            const response = await fetch('/biometria/register/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken'),
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify(pendingCredential)
            });
            
            const result = await response.json();
            
            if (result.success) {
                deviceNameModal.hide();
                alert('✓ Biometria configurada com sucesso!');
                location.reload();
            } else {
                throw new Error(result.error || 'Erro ao salvar credencial');
            }
            
        } catch (error) {
            alert('Erro: ' + error.message);
        }
    });
    
    // Event listeners
    if (setupBtn) {
        setupBtn.addEventListener('click', registerBiometric);
    }
    
    if (addDeviceBtn) {
        addDeviceBtn.addEventListener('click', registerBiometric);
    }
    
    // Deletar credencial
    document.querySelectorAll('.delete-credential-btn').forEach(btn => {
        btn.addEventListener('click', async function() {
            const id = this.dataset.id;
            const name = this.dataset.name;
            
            if (!confirm(`Tem certeza que deseja remover "${name}"?`)) return;
            
            try {
                const response = await fetch(`/biometria/delete/${id}/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken'),
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('Dispositivo removido com sucesso!');
                    location.reload();
                } else {
                    throw new Error(result.error || 'Erro ao remover');
                }
                
            } catch (error) {
                alert('Erro: ' + error.message);
            }
        });
    });
});
</script>
{% endblock %}
